name: Postman Acceptance Tests Run On Built API

on:
  push:
    branches:
      - '71-implement-postman-integration-with-ci-pipeline'
  #workflow_run:
    #workflows: ["Maven Docker Push"]
    #branches: [main]
    #types: 
      #- completed

jobs:
  testing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run API image
        uses: addnab/docker-run-action@v3
        with:
          image: famezs/npe-interview-application:latest
        env:
          SPRING_DATASOURCE_URL: "jdbc:postgresql://db:5432/localdb"
          SPRING_DATASOURCE_USERNAME: "localdb"
          SPRING_DATASOURCE_PASSWORD: "localdb"
      
      - name: Setup PostgreSQL database
        uses: addnab/docker-run-action@v3
        with:
          image: postgres:14.4-alpine
        env:
          POSTGRES_DB: "localdb"
          POSTGRES_PASSWORD: "localdb"
          POSTGRES_USER: "localdb"
      
      - name: Install Node
        uses: actions/setup-node@v1
        with: 
          node-version: '12.x'

      - name: Install newman
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra

      - name: Make Directory for test results
        run: mkdir -p testResults

      - name: Run POSTMAN collection
        run: |
          newman run ./src/test/postman-tests.json -r htmlextra --reporter-htmlextra-export testResults/htmlreport.html --reporter-htmlextra-darkTheme  > testResults/runreport1.html

      - name: Output the run Details
        uses: actions/upload-artifact@v2
        with: 
          name: RunReports
          path: testResults        
    